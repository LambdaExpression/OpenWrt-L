name: Build x86/64 openwrt

on:
  push:
    paths:
      - "version"
      - ".github/workflows/**"
      
env:
  CONFIG_FILE: config/x86/64.config
  SOURCE_URL: https://github.com/coolsnowwolf/lede
  SOURCE_BRANCH: 20211107
  TOOLCHAIN_TAG: Build x86/64 openwrt
  CLASH_BINARY_PLATFORM: amd64
  FIRMWARE_RELEASE_UPLOAD: false
  TZ: Asia/Shanghai

jobs:
  Toolchain:
    runs-on: ubuntu-20.04

    steps:
    
#      - name: Initialization Environment
#        env:
#          DEBIAN_FRONTEND: noninteractive
#        run: |
#          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
#          sudo -E apt-get -qq update
#          sudo -E apt-get -qq install squashfs-tools $(curl -fsSL git.io/depends-ubuntu-2004)
#          sudo -E apt-get -qq autoremove --purge
#          sudo -E apt-get -qq clean
#          sudo ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
#          docker image prune -a -f
#          mkdir -p workspace
          
      - name: Checkout
        uses: actions/checkout@main

      - name: Clone Source Code
        id: clone
        run: |
          df -hT $PWD
          git clone $SOURCE_URL -b $SOURCE_BRANCH workspace/openwrt
          cd workspace/openwrt
          echo "OPENWRT_ROOT_PATH=$PWD" >> $GITHUB_ENV
          echo "::set-output name=OPENWRT_ROOT_PATH::$(echo $PWD)"
          
      - name: Generate Toolchain Config
        run: |
          [ -e $CONFIG_FILE ] && mv $CONFIG_FILE $OPENWRT_ROOT_PATH/.config
          echo -e "\nCONFIG_ALL=y" >> $OPENWRT_ROOT_PATH/.config
          echo -e "\nCONFIG_ALL_NONSHARED=y" >> $OPENWRT_ROOT_PATH/.config
          cd $OPENWRT_ROOT_PATH
          make defconfig > /dev/null 2>&1
          
          
      - name: Install Feeds
        if: steps.hash.outputs.REBUILD_TOOLCHAIN == 'true'
        run: |
          cd $OPENWRT_ROOT_PATH
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          make defconfig
          
      - name: Compile Tools
        if: steps.hash.outputs.REBUILD_TOOLCHAIN == 'true'
        run: |
          cd $OPENWRT_ROOT_PATH
          echo -e "$(nproc) thread compile"
          make tools/compile -j$(nproc) || make tools/compile -j1 V=s    
          
      - name : Test
        run : |
          tree
